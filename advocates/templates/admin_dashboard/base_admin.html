{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{% block title %}Admin Dashboard{% endblock %}</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"> 
<script src="//unpkg.com/alpinejs" defer></script>
<style>
body, input, select, textarea { font-family: 'Poppins', sans-serif; margin:0; background:#f0f3f7; color:#1f2937; }
.dashboard{display:flex;height:100vh;overflow:hidden;transition:0.3s;}
.sidebar{width:280px;background:#1a202c;color:#fff;display:flex;flex-direction:column;transition:0.3s ease-in-out;z-index:20;}
.sidebar .logo-container{padding:1.5rem 2rem;border-bottom:1px solid rgba(255,255,255,0.1);text-align:center;}
.sidebar nav{padding:1rem 0;}
.sidebar nav a, .sidebar nav button{padding:0.75rem 2rem;display:flex;align-items:center;gap:0.75rem;color:#d1d5db;text-decoration:none;font-size:0.95rem;font-weight:500;transition:0.2s ease-in-out;border-left:4px solid transparent;}
.sidebar nav a:hover, .sidebar nav button:hover{background:#2d3748;color:#fff;border-left-color:#3B82F6;}
.sidebar nav a.active{border-left-color:#3B82F6;color:#fff;background:#2d3748;}
.sidebar nav li button.w-full{font-size:0.95rem;font-weight:500;}
.sidebar nav ul.ml-4{background:#1f2937;border-radius:0 8px 8px 0;padding:0.5rem 0;}
.sidebar nav ul li a{padding:0.5rem 2.5rem;font-size:0.9rem;}
.sidebar nav ul li a:hover{background:#374151;color:#fff;}
/* Scrollbar for sidebar */
.sidebar::-webkit-scrollbar { width: 6px; }
.sidebar::-webkit-scrollbar-thumb { background-color:#3B82F6; border-radius:10px; }
.sidebar::-webkit-scrollbar-thumb:hover { background-color:#2563eb; }
/* Rest of the existing styles remain unchanged */
.main{flex:1;overflow-y:auto;padding-bottom:2rem;transition:0.3s;}
.topbar{height:70px;background:#fff;display:flex;justify-content:space-between;align-items:center;padding:0 2rem;box-shadow:0 2px 8px rgba(0,0,0,0.05);position:sticky;top:0;z-index:10;}
.topbar input{padding:0.5rem 1rem;border-radius:10px;border:1px solid #e5e7eb;width:300px;}
.hamburger{display:none;cursor:pointer;font-size:1.5rem;}
.cards { display: grid; gap: 2rem; padding: 2rem; grid-template-columns: repeat(2, 1fr); }
@media(min-width:1024px){ .cards { grid-template-columns: repeat(4, 1fr); } }
.card{background:rgba(255,255,255,0.85);backdrop-filter:blur(10px);padding:1.5rem;border-radius:15px;box-shadow:0 8px 20px rgba(0,0,0,0.05);}
.card h3{font-weight:600;color:#6b7280;margin-bottom:0.5rem;}
.card p{font-size:1.8rem;font-weight:700;color:#111827;}
#calendar{width:calc(100% - 4rem); margin:2rem; background:#fff;padding:1rem;border-radius:15px;box-shadow:0 8px 20px rgba(0,0,0,0.05);height:650px;min-height:650px;max-height:650px; font-family:'Poppins',sans-serif;}
.table-container, .recent-activities{margin:2rem;background:#fff;border-radius:15px;padding:1rem;box-shadow:0 8px 20px rgba(0,0,0,0.05); max-height:250px; overflow-y:auto;}
table{width:100%;border-collapse:separate;border-spacing:0 0.75rem;}
th,td{text-align:left;padding:0.75rem;}
th{color:#6b7280;font-weight:600;}
tr{background:#f9fafb;border-radius:10px;}
tr td{background:#fff;padding:0.75rem;border-radius:10px;}
.activity-item{padding:0.75rem;border-bottom:1px solid #e5e7eb;}
.activity-item:last-child{border-bottom:none;}
.avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;}
/* Responsive */
@media(max-width:1024px){#calendar{height:500px;min-height:500px;max-height:500px;}}
@media(max-width:768px){
    .dashboard{flex-direction:column;}
    .sidebar{position:absolute;left:-280px;top:0;height:100%;transition:0.3s;}
    .sidebar.active{left:0;}
    .topbar input{width:150px;}
    .hamburger{display:block;}
    #calendar{width:calc(100% - 2rem);margin:1rem;height:450px;min-height:450px;max-height:450px;}
    .cards{grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem;padding:1rem;}
}
#notificationDropdown {
    max-height: 500px;
    overflow-y: auto;
}
</style>
</head>
<body>
<div class="dashboard">
    <!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="logo-container">
        <a href="{% url 'home' %}" aria-label="Muguna & Oyile Home">
            <img src="{% static 'images/admin_logo.png' %}" 
                 alt="Muguna & Oyile Law Firm Logo" 
                 width="180" 
                 height="60"
                 loading="eager">
        </a>
    </div>
    <nav>
        <a href="{% url 'analytics_dashboard' %}" class="{% if request.resolver_match.url_name == 'analytics_dashboard' %}active{% endif %} px-4 py-2 text-gray-300 hover:bg-gray-800 rounded">Analytics</a>
        <!-- Dashboard -->
        <a href="{% url 'admin_dashboard_home' %}" class="{% if request.resolver_match.url_name == 'admin_dashboard_home' %}active{% endif %}">üè† Dashboard</a>

        <!-- Client Interactions -->
        <li x-data="{ open: false }" class="relative">
            <button @click="open = !open" class="w-full flex items-center justify-between px-4 py-2 hover:bg-gray-800 rounded text-gray-300 font-medium focus:outline-none">
                <span class="flex items-center gap-2">üë• Client Interactions</span>
                <svg :class="{ 'rotate-180': open }" class="w-4 h-4 text-gray-300 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>
            <ul x-show="open" x-transition x-cloak class="ml-4 mt-1 space-y-1">
                <li><a href="{% url 'admin_dashboard_calls' %}" class="{% if request.resolver_match.url_name == 'admin_dashboard_calls' %}active{% endif %} block px-4 py-2 text-gray-300 hover:bg-gray-700 rounded">üìÖ Scheduled Calls</a></li>
                <li><a href="{% url 'admin_dashboard_contacts' %}" class="{% if request.resolver_match.url_name == 'admin_dashboard_contacts' %}active{% endif %} block px-4 py-2 text-gray-300 hover:bg-gray-700 rounded">‚úâÔ∏è Contact Messages</a></li>
            </ul>
        </li>

        <!-- Notifications -->
        <li x-data="{ open: false }" class="relative">
            <button @click="open = !open" class="w-full flex items-center justify-between px-4 py-2 hover:bg-gray-800 rounded text-gray-300 font-medium focus:outline-none">
                <span class="flex items-center gap-2">üîî Notifications</span>
                <svg :class="{ 'rotate-180': open }" class="w-4 h-4 text-gray-300 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>
            <ul x-show="open" x-transition x-cloak class="ml-4 mt-1 space-y-1">
                <li>
                    <a href="{% url 'all_notifications' %}" class="{% if request.resolver_match.url_name == 'all_notifications' %}active{% endif %} flex justify-between px-4 py-2 text-gray-300 hover:bg-gray-700 rounded">
                        All Notifications
                        {% if total_notifications and total_notifications > 0 %}
                        <span class="ml-2 bg-blue-600 text-white text-xs font-semibold px-2 py-0.5 rounded-full">{{ total_notifications }}</span>
                        {% endif %}
                    </a>
                </li>
                <li>
                    <a href="{% url 'red_flag_messages' %}" class="{% if request.resolver_match.url_name == 'red_flag_messages' %}active{% endif %} flex justify-between px-4 py-2 text-red-500 hover:text-red-600 hover:bg-gray-700 rounded">
                        Red Flag Messages
                        {% if red_flag_count and red_flag_count > 0 %}
                        <span class="ml-2 bg-red-600 text-white text-xs font-semibold px-2 py-0.5 rounded-full">{{ red_flag_count }}</span>
                        {% endif %}
                    </a>
                </li>
            </ul>
        </li>

        <!-- Blogs -->
        <li x-data="{ open: false }" class="relative">
    <button @click="open = !open" class="w-full flex items-center justify-between px-4 py-2 hover:bg-gray-800 rounded text-gray-300 font-medium focus:outline-none">
        <span class="flex items-center gap-2">‚úçÔ∏è Blogs</span>
        <svg :class="{ 'rotate-180': open }" class="w-4 h-4 text-gray-300 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
    </button>
    <ul x-show="open" x-transition x-cloak class="ml-4 mt-1 space-y-1">
        <li><a href="{% url 'article_create' %}" class="{% if request.resolver_match.url_name == 'article_create' %}active{% endif %} block px-4 py-2 text-gray-300 hover:bg-gray-700 rounded">‚ûï New Blog</a></li>
        <li><a href="{% url 'manage_blogs' %}" class="{% if request.resolver_match.url_name == 'manage_blogs' %}active{% endif %} block px-4 py-2 text-gray-300 hover:bg-gray-700 rounded">üìù Manage Blogs</a></li>
        <li><a href="{% url 'manage_quotes' %}" class="{% if request.resolver_match.url_name == 'manage_quotes' %}active{% endif %} block px-4 py-2 text-gray-300 hover:bg-gray-700 rounded">üìú Manage Quotes</a></li>
    </ul>
</li>

        <!--Feedback-->
        <a href="{% url 'feedback_page' %}" class="{% if request.resolver_match.url_name == 'feedback_page' %}active{% endif %} px-4 py-2 text-gray-300 hover:bg-gray-800 rounded">üí¨ Feedback</a>
        <!-- Activity Log -->
        <a href="{% url 'admin_dashboard_activity' %}" class="{% if request.resolver_match.url_name == 'admin_dashboard_activity' %}active{% endif %} px-4 py-2 text-gray-300 hover:bg-gray-800 rounded">üìù Activity Log</a>
    </nav>
</div>

    <!-- Main content -->
    <div class="main">
        <div class="topbar">
            <div style="display:flex;align-items:center;gap:1rem;">
                <span class="hamburger" id="hamburger">&#9776;</span>
                <input type="text" placeholder="Search admin logs, users, etc...">
            </div>
            <div class="flex items-center gap-4">
                <!-- Notification bell -->
                <div class="relative inline-block">
                    <button id="notificationBell" class="relative p-2 rounded-full hover:bg-gray-200 focus:outline-none">
                        <svg class="h-6 w-6 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none"
                             viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 17h5l-1.405-1.405C18.21 14.79 18 13.918 18 13V9a6 6 0 10-12 0v4c0 .918-.21 1.79-.595 2.595L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                        </svg>
                        <span id="notificationDot" class="hidden absolute top-0 right-0 block h-2 w-2 rounded-full bg-red-600"></span>
                    </button>
                    <div id="notificationDropdown"
                         class="hidden absolute right-0 mt-2 w-80 bg-white border border-gray-300 rounded-lg shadow-lg z-50">
                        <div class="p-4" id="notificationList">
                          <p class="text-gray-500 text-sm">Loading notifications...</p>
                        </div>
                        <div class="p-2 border-t text-center">
                          <a href="{% url 'all_notifications' %}" class="text-blue-600 hover:underline text-sm">View all</a>
                        </div>
                    </div>
                </div>

                <!-- Profile dropdown -->
                <div class="relative">
                    <button id="profileButton" class="flex items-center gap-2 p-2 rounded hover:bg-gray-200 focus:outline-none">
                        <img src="https://i.pravatar.cc/40?img=1" alt="Profile" class="avatar">
                        <span>{{ admin_name|default:"Admin User" }}</span>
                        <svg class="w-4 h-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-300 rounded-lg shadow-lg z-50">
                        <a href="{% url 'admin_profile' %}" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">‚öôÔ∏è Profile Settings</a>
                        <form method="POST" action="{% url 'logout' %}">
                            {% csrf_token %}
                            <button type="submit" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100">üö™ Logout</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="content">
            {% block dashboard_content %}{% endblock dashboard_content %}
        </div>
    </div>
</div>

<script>
// Sidebar toggle
const sidebar = document.getElementById('sidebar');
const hamburger = document.getElementById('hamburger');
hamburger.addEventListener('click', (e) => {
    sidebar.classList.toggle('active');
    e.stopPropagation();
});
document.addEventListener('click', (e) => {
    if (window.innerWidth <= 768) {
        if (!sidebar.contains(e.target) && !hamburger.contains(e.target)) {
            sidebar.classList.remove('active');
        }
    }
});

// Profile dropdown toggle
document.addEventListener("DOMContentLoaded", function () {
    const profileButton = document.getElementById("profileButton");
    const profileDropdown = document.getElementById("profileDropdown");

    profileButton.addEventListener("click", function (e) {
        e.stopPropagation();
        profileDropdown.classList.toggle("hidden");
    });

    document.addEventListener("click", function () {
        if (!profileDropdown.classList.contains("hidden")) {
            profileDropdown.classList.add("hidden");
        }
    });

    // Notification bell
    const bell = document.getElementById("notificationBell");
    const dropdown = document.getElementById("notificationDropdown");
    const list = document.getElementById("notificationList");
    const dot = document.getElementById("notificationDot");

    bell.addEventListener("click", function (e) {
        e.stopPropagation();
        dropdown.classList.toggle("hidden");

        fetch("{% url 'fetch_notifications' %}")
        .then(response => response.json())
        .then(data => {
            list.innerHTML = "";
            const notifications = data.notifications || [];
            if (notifications.length === 0) {
                list.innerHTML = "<p class='text-gray-500 text-sm'>No notifications üéâ</p>";
                dot.classList.add("hidden");
            } else {
                dot.classList.remove("hidden");
                notifications.forEach(item => {
                    const entry = document.createElement("div");
                    entry.classList.add("p-2", "border-b", "hover:bg-gray-50", "cursor-pointer");
                    
                    let typeColor = "text-blue-600";
                    if (item.type === "call") typeColor = "text-green-600";
                    if (item.type === "red-flag") typeColor = "text-red-600";
                    
                    // üí° FIX: Dynamically generate the detail based on type
                    let primaryDetail = "";
                    if (item.type === "call") {
                        const timeDisplay = item.time_slot ? `at ${item.time_slot}` : ' (Unscheduled)';
                        primaryDetail = `${item.client}${timeDisplay}`;
                    } else {
                        primaryDetail = `${item.subject || "No Subject"} ‚Äî ${item.client}`;
                    }

                    entry.innerHTML = `
                        <p class="text-xs font-semibold ${typeColor}">${item.type.toUpperCase()}</p>
                        <p class="text-sm">${primaryDetail}</p>
                        <p class="text-xs text-gray-500">${item.created_at}</p>
                    `;
                    
                    entry.addEventListener("click", () => {
                        if (item.type === "message" || item.type === "red-flag") {
                            window.location.href = "{% url 'admin_dashboard_contacts' %}";
                        } else if (item.type === "call") {
                            window.location.href = "{% url 'admin_dashboard_calls' %}";
                        }
                    });
                    list.appendChild(entry);
                });
            }
        })
        .catch(err => {
            console.error("Notification fetch failed:", err);
            list.innerHTML = "<p class='text-red-500 text-sm'>Failed to load notifications</p>";
        });
    });

    document.addEventListener("click", function (e) {
        if (!dropdown.classList.contains("hidden") &&
            !bell.contains(e.target) &&
            !dropdown.contains(e.target)) {
            dropdown.classList.add("hidden");
        }
    });

    // Initial notification check
    fetch("{% url 'fetch_notifications' %}")
    .then(response => response.json())
    .then(data => {
        if ((data.notifications || []).length > 0) dot.classList.remove("hidden");
    }).catch(()=>{});
});
</script>
</body>
</html>

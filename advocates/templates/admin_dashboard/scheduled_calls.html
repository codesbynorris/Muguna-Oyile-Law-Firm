{% extends "admin_dashboard/base_admin.html" %}
{% load static %}

{% block title %}Scheduled Calls{% endblock %}

{% block dashboard_content %}
<div class="p-4 sm:p-6">
    <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-gray-800 font-header">Scheduled Calls</h1>

    <!-- Filter Bar -->
    <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between bg-white p-4 rounded-xl shadow-md border border-gray-200">
        <div class="relative w-full sm:w-64 mb-4 sm:mb-0">
            <form id="statusFilterForm" method="GET" action="{% url 'admin_dashboard_calls' %}">
                <select id="statusFilter" name="status"
                    class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm text-gray-700 focus:ring-indigo-500 focus:border-indigo-500 bg-white font-content"
                    onchange="this.form.submit()">
                    <option value="" {% if not selected_status %}selected{% endif %}>All Calls</option>
                    <option value="confirmed" {% if selected_status == 'confirmed' %}selected{% endif %}>Confirmed</option>
                    <option value="pending" {% if selected_status == 'pending' %}selected{% endif %}>Pending</option>
                </select>
            </form>
        </div>
        <div class="flex items-center space-x-3">
            <input type="checkbox" id="selectAll" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
            <button class="text-gray-500 hover:text-indigo-600 transition-colors" title="Refresh" onclick="window.location.reload()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m15.356-2H21v5"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Calls Table -->
    <div class="overflow-x-auto border border-gray-200 rounded-2xl shadow-2xl bg-white">
        <table class="min-w-[800px] w-full table-auto border-collapse">
            <thead class="bg-indigo-50 border-b border-indigo-100">
                <tr>
                    <th class="px-4 py-3 text-left font-semibold text-indigo-700 tracking-wider text-sm w-12 sm:w-16">
                        <input type="checkbox" id="selectAll" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    </th>
                    <th class="px-4 py-3 text-left font-semibold text-indigo-700 tracking-wider text-sm">Name</th>
                    <th class="px-4 py-3 text-left font-semibold text-indigo-700 tracking-wider text-sm">Schedule</th>
                    <th class="px-4 py-3 text-left font-semibold text-indigo-700 tracking-wider text-sm">Category/Subject</th>
                    <th class="px-4 py-3 text-right font-semibold text-indigo-700 tracking-wider text-sm w-20 sm:w-24">Status</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for call in calls %}
                <tr class="message-row hover:bg-indigo-50/30 transition-colors duration-150 {% if not call.is_read %}bg-blue-50{% endif %}"
                    data-call-id="{{ call.id }}"
                    data-first-name="{{ call.first_name }}"
                    data-last-name="{{ call.last_name }}"
                    data-email="{{ call.email }}"
                    data-phone="{{ call.phone_number }}"
                    data-subject="{{ call.subject }}"
                    data-date="{{ call.date|date:'M d, Y' }}"
                    data-time="{{ call.time_slot|default:'N/A' }}"
                    data-confirmed="{{ call.is_confirmed|yesno:'Yes,No' }}">
                    <td class="px-4 py-3 text-center">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 call-checkbox">
                            <svg class="w-5 h-5 {% if call.is_starred %}text-yellow-500{% else %}text-gray-400 hover:text-yellow-500{% endif %} transition-colors star-icon"
                                fill="{% if call.is_starred %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11.049 2.152A.75.75 0 0112 2.25c.54 0 1.059.324 1.309.854l1.83 3.868a.75.75 0 00.56.439l4.385.637a.75.75 0 01.417 1.27l-3.17 3.093a.75.75 0 00-.215.688l.75 4.363a.75.75 0 01-1.082.784L12 18.017l-3.921 2.067a.75.75 0 01-1.082-.784l.75-4.363a.75.75 0 00-.215-.688l-3.17-3.093a.75.75 0 01.417-1.27l4.385-.637a.75.75 0 00.56-.439l1.83-3.868a.75.75 0 01.309-.854z"></path>
                            </svg>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm font-semibold text-gray-800 {% if not call.is_read %}font-bold{% endif %}">{{ call.first_name }} {{ call.last_name }}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">{{ call.date|date:"M d" }} at {{ call.time_slot|default:'TBD' }}</td>
                    <td class="px-4 py-3 text-sm font-medium text-indigo-600">{{ call.subject }}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 text-right relative">
                        <div class="date-column transition-opacity duration-150">
                            {% if call.is_confirmed %}
                                <span class="text-xs font-semibold text-green-600">Confirmed</span>
                            {% else %}
                                <span class="text-xs font-semibold text-yellow-600">Pending</span>
                            {% endif %}
                        </div>
                        <div class="icon-wrapper absolute top-1/2 right-4 transform -translate-y-1/2 space-x-2 hidden sm:flex opacity-0 transition-opacity duration-150">
                            {% if not call.is_confirmed %}
                            <a href="{% url 'admin_confirm_call' call.id %}" class="text-green-600 hover:text-green-800" title="Confirm">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </a>
                            <a href="{% url 'admin_decline_call' call.id %}" class="text-red-600 hover:text-red-800" title="Decline">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </a>
                            {% endif %}
                            <button class="text-gray-500 hover:text-gray-700 archive-btn" title="Archive" data-call-id="{{ call.id }}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                            </button>
                            <button class="text-gray-500 hover:text-gray-700 delete-btn" title="Delete" data-call-id="{{ call.id }}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="px-4 py-10 text-center text-gray-500 font-content">No scheduled calls{% if selected_status %} ({{ selected_status|capfirst }}){% endif %}.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if calls.has_other_pages %}
    <div class="mt-6 flex justify-center">
        <nav class="inline-flex space-x-2" aria-label="Pagination">
            {% if calls.has_previous %}
            <a href="?page={{ calls.previous_page_number }}{% if selected_status %}&status={{ selected_status|urlencode }}{% endif %}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">Previous</a>
            {% endif %}
            {% for num in calls.paginator.page_range %}
            <a href="?page={{ num }}{% if selected_status %}&status={{ selected_status|urlencode }}{% endif %}" class="{% if calls.number == num %}bg-indigo-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} px-4 py-2 rounded-lg transition-colors">{{ num }}</a>
            {% endfor %}
            {% if calls.has_next %}
            <a href="?page={{ calls.next_page_number }}{% if selected_status %}&status={{ selected_status|urlencode }}{% endif %}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">Next</a>
            {% endif %}
        </nav>
    </div>
    {% endif %}

    <!-- Modal (Styled Like Contact Messages) -->
    <div id="callModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-gray-900/40 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto font-content message-modal border border-gray-100">
            <div class="logo-section text-center py-6 border-b border-gray-100 bg-gray-50 rounded-t-xl">
                <a href="#">
                    <img src="{% static 'images/logo.png' %}" alt="Muguna & Oyile Law Firm Logo" width="180" height="60" loading="eager" class="mx-auto">
                </a>
            </div>

            <div class="content-area px-8 sm:px-10 py-6">
                <h1 id="modalSubject" class="text-2xl font-semibold text-indigo-700 mb-4 font-header border-b pb-3 border-indigo-100"></h1>
                <p class="text-sm text-gray-600 leading-relaxed mb-6">Review the scheduled consultation details below:</p>

                <div class="details-section text-sm text-gray-700 mb-8 space-y-3">
                    <div class="flex leading-relaxed items-start"><span class="w-40 text-gray-600 font-normal">Client:</span><span id="modalName" class="font-semibold text-gray-800 flex-1"></span></div>
                    <div class="flex leading-relaxed items-start"><span class="w-40 text-gray-600 font-normal">Email:</span><span id="modalEmail" class="font-semibold text-indigo-600 flex-1"></span></div>
                    <div class="flex leading-relaxed items-start"><span class="w-40 text-gray-600 font-normal">Phone:</span><span id="modalPhone" class="font-semibold text-gray-800 flex-1"></span></div>
                    <div class="flex leading-relaxed items-start"><span class="w-40 text-gray-600 font-normal">Topic:</span><span id="modalSubjectField" class="font-semibold text-gray-800 flex-1"></span></div>
                    <div class="flex leading-relaxed items-start pt-2 border-t border-gray-100"><span class="w-40 text-gray-600 font-normal">Date:</span><span id="modalDate" class="font-bold text-indigo-600 flex-1"></span></div>
                    <div class="flex leading-relaxed items-start"><span class="w-40 text-gray-600 font-normal">Time:</span><span id="modalTime" class="font-bold text-indigo-600 flex-1"></span></div>
                    <div class="flex leading-relaxed items-start"><span class="w-40 text-gray-600 font-normal">Confirmed:</span><span id="modalConfirmed" class="font-semibold text-gray-800 flex-1"></span></div>
                </div>

                <div id="modalActions" class="mt-4 flex justify-end space-x-2"></div>
            </div>

            <div class="footer-text text-center text-sm text-gray-600 py-4 px-8 sm:px-10 border-t border-gray-200 bg-gray-50 rounded-b-xl flex justify-between items-center">
                <button id="closeModal" class="px-5 py-2 bg-indigo-600 rounded-lg text-white hover:bg-indigo-700 transition-colors shadow-md font-semibold">Close</button>
                <div class="text-right text-xs text-gray-500">ID: <span id="modalCallId" class="font-bold text-gray-700"></span></div>
            </div>
        </div>
    </div>
</div>

<style>
:root {
    --font-header: 'Poppins', serif;
    --font-content: 'Open Sans', sans-serif;
}
.font-header { font-family: var(--font-header); }
.font-content { font-family: var(--font-content); }

.rounded-2xl { border-radius: 1rem; }
.shadow-2xl { box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); }

.overflow-x-auto::-webkit-scrollbar { height: 8px; }
.overflow-x-auto::-webkit-scrollbar-thumb { background-color: #6366F1; border-radius: 10px; }
.overflow-x-auto::-webkit-scrollbar-thumb:hover { background-color: #4F46E5; }

.message-row .icon-wrapper { opacity: 0; transition: opacity 0.15s ease-in-out; }
.message-row:hover .icon-wrapper { opacity: 1; }
.message-row:hover .date-column { opacity: 0; }

.message-modal { transition: all 0.3s cubic-bezier(0.25,0.8,0.25,1); transform: scale(0.95); opacity: 0; }
.message-modal.active { transform: scale(1); opacity: 1; }

@media(max-width:768px){
    table th, table td { padding: 0.75rem 0.5rem; font-size: 0.875rem; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Setup Variables ---
    const selectAll = document.getElementById('selectAll');
    const callRows = document.querySelectorAll('.message-row');
    const modal = document.getElementById('callModal');
    const modalContent = modal.querySelector('.message-modal');
    const closeModalButton = modal.querySelector('#closeModal');

    // Modal Field Elements
    const modalName = document.getElementById('modalName');
    const modalEmail = document.getElementById('modalEmail');
    const modalPhone = document.getElementById('modalPhone');
    const modalSubject = document.getElementById('modalSubject');
    const modalSubjectField = document.getElementById('modalSubjectField');
    const modalDate = document.getElementById('modalDate');
    const modalTime = document.getElementById('modalTime');
    const modalConfirmed = document.getElementById('modalConfirmed');
    const modalActions = document.getElementById('modalActions');
    
    // --- Functions ---
    const hideModal = () => {
        modalContent.classList.remove('active');
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 300);
    };

    const showModal = (callData) => {
        modalName.textContent = `${callData.firstName} ${callData.lastName}`;
        modalEmail.textContent = callData.email;
        modalPhone.textContent = callData.phone;
        modalSubject.textContent = callData.subject;
        modalSubjectField.textContent = callData.subject;
        modalDate.textContent = callData.date;
        modalTime.textContent = callData.time;
        
        if (callData.confirmed === 'Yes') {
            modalConfirmed.innerHTML = '<span class="text-green-600 font-bold">Confirmed</span>';
        } else {
            modalConfirmed.innerHTML = '<span class="text-yellow-600 font-bold">Pending</span>';
        }

        modalActions.innerHTML = '';
        if (callData.confirmed === 'No') {
            modalActions.innerHTML = `
                <a href="/admin-dashboard/call/confirm/${callData.callId}/" class="px-4 py-2 text-xs bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold shadow-sm">Confirm</a>
                <a href="/admin-dashboard/call/decline/${callData.callId}/" class="px-4 py-2 text-xs bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold shadow-sm">Decline</a>
            `;
        }

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        void modalContent.offsetWidth;
        modalContent.classList.add('active');
    };

    // --- Event Listeners ---

    // 1. Select All
    selectAll.addEventListener('change', () => {
        document.querySelectorAll('.call-checkbox').forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
    });

    // 2. Row Click Handler (Opens Modal)
    callRows.forEach(row => {
        row.addEventListener('click', (event) => {
            const interactiveElements = event.target.closest('input[type="checkbox"], button, svg, a');
            if (interactiveElements) {
                return;
            }

            const callData = {
                callId: row.getAttribute('data-call-id'),
                firstName: row.querySelector('td:nth-child(2)').textContent.trim().split(/\s+/)[0],
                lastName: row.querySelector('td:nth-child(2)').textContent.trim().split(/\s+/).slice(1).join(' '),
                email: row.getAttribute('data-email'),
                phone: row.getAttribute('data-phone'),
                subject: row.querySelector('td:nth-child(4)').textContent,
                date: row.getAttribute('data-date'),
                time: row.getAttribute('data-time'),
                confirmed: row.getAttribute('data-confirmed')
            };
            showModal(callData);

            // Mark as read visually
            row.classList.remove('bg-blue-50');
            row.querySelectorAll('.font-bold').forEach(el => {
                el.classList.remove('font-bold');
                el.classList.add('font-semibold');
            });
            
            // Mark as read in the backend
            fetch(`/admin/scheduled-calls/${callData.callId}/mark-read/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    console.error('Failed to mark call as read:', response.status);
                    row.classList.add('bg-blue-50');
                    row.querySelectorAll('.font-semibold').forEach(el => {
                        el.classList.remove('font-semibold');
                        el.classList.add('font-bold');
                    });
                }
            })
            .catch(err => {
                console.error('Error marking as read:', err);
                row.classList.add('bg-blue-50');
                row.querySelectorAll('.font-semibold').forEach(el => {
                    el.classList.remove('font-semibold');
                    el.classList.add('font-bold');
                });
            });
        });
    });

    // 3. Close Modal handlers
    closeModalButton.addEventListener('click', hideModal);
    modal.addEventListener('click', (event) => {
        if (event.target === modal) {
            hideModal();
        }
    });

    // 4. Star, Archive, Delete handlers
    const handleAction = (event, endpoint, method = 'POST') => {
        event.stopPropagation();
        const callId = event.target.closest('.message-row')?.getAttribute('data-call-id') || event.target.getAttribute('data-call-id');
        
        if (!callId) {
            console.error('Call ID not found for action.');
            return;
        }

        const fetchOptions = {
            method: method,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        };

        fetch(endpoint.replace('{id}', callId), fetchOptions)
            .then(response => {
                if (response.ok) {
                    if (endpoint.includes('delete') || endpoint.includes('archive')) {
                        event.target.closest('.message-row').remove();
                    } else if (endpoint.includes('toggle-star')) {
                        const star = event.target.closest('svg');
                        const isStarred = star.getAttribute('fill') === 'currentColor';
                        star.setAttribute('fill', isStarred ? 'none' : 'currentColor');
                        star.classList.toggle('text-yellow-500', !isStarred);
                        star.classList.toggle('text-gray-400', isStarred);
                    }
                }
            })
            .catch(err => console.error(`Error performing action for ${endpoint}:`, err));
    };

    document.querySelectorAll('.star-icon').forEach(star => star.addEventListener('click', (e) => handleAction(e, `/admin/scheduled-calls/{id}/toggle-star/`)));
    document.querySelectorAll('.archive-btn').forEach(btn => btn.addEventListener('click', (e) => handleAction(e, `/admin/scheduled-calls/{id}/archive/`)));
    document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => handleAction(e, `/admin/scheduled-calls/{id}/delete/`)));
});
</script>
{% endblock %}

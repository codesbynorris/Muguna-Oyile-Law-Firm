{% extends "admin_dashboard/base_admin.html" %}
{% load static %}

{% block title %}Scheduled Calls{% endblock %}

{% block dashboard_content %}
<div class="p-4 sm:p-6">
    <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-gray-800 font-header" style="font-family: 'EB Garamond', serif;">Scheduled Calls</h1>

    <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between bg-white p-4 rounded-3xl shadow-2xl border border-gray-200">
        <div class="relative w-full sm:w-64 mb-4 sm:mb-0">
            <select id="subjectFilter" class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm text-gray-700 focus:ring-indigo-500 focus:border-indigo-500 bg-white font-content" style="font-family: 'Open Sans', sans-serif;">
                <option value="">All Subjects</option>
                {% comment %} NOTE: You will need to populate the 'subjects' context variable in your Django view {% endcomment %}
                {% for subject in subjects %}
                    <option value="{{ subject }}">{{ subject }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="flex items-center space-x-3">
            <input type="checkbox" id="selectAll" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
            <button class="text-gray-500 hover:text-gray-700" title="Refresh" onclick="window.location.reload()">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m15.356-2H21v5"></path>
                </svg>
            </button>
        </div>
    </div>

    <div class="border rounded-3xl shadow-2xl bg-white">
        <div id="call-list" class="divide-y divide-gray-200">
            {% for call in calls %}
            <article class="message-row flex items-center p-3 cursor-pointer hover:shadow-md hover:z-10 transition-all duration-150 {% if not call.is_read %}bg-blue-50{% endif %}" 
                     data-call-id="{{ call.id }}"
                     data-first-name="{{ call.first_name }}"
                     data-last-name="{{ call.last_name }}"
                     data-email="{{ call.email }}"
                     data-phone="{{ call.phone_number }}"
                     data-subject="{{ call.get_subject_display|default:'Call Request' }}"
                     data-date="{{ call.date|date:'M d, Y' }}"
                     data-time="{{ call.time_slot|default:'N/A' }}"
                     data-confirmed="{{ call.is_confirmed|yesno:'Yes,No' }}">
                
                <div class="flex items-center space-x-2 flex-shrink-0 pr-3 w-12 sm:w-16">
                    <input type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 call-checkbox">
                    <svg class="w-5 h-5 {% if call.is_starred %}text-yellow-500{% else %}text-gray-400 hover:text-yellow-500{% endif %} transition-colors sm:block star-icon" fill="{% if call.is_starred %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.152A.75.75 0 0112 2.25c.54 0 1.059.324 1.309.854l1.83 3.868a.75.75 0 00.56.439l4.385.637a.75.75 0 01.417 1.27l-3.17 3.093a.75.75 0 00-.215.688l.75 4.363a.75.75 0 01-1.082.784L12 18.017l-3.921 2.067a.75.75 0 01-1.082-.784l.75-4.363a.75.75 0 00-.215-.688l-3.17-3.093a.75.75 0 01.417-1.27l4.385-.637a.75.75 0 00.56-.439l1.83-3.868a.75.75 0 01.309-.854z"></path>
                    </svg>
                </div>

                <div class="w-20 sm:w-32 {% if not call.is_read %}font-semibold{% endif %} text-gray-900 truncate flex-shrink-0 font-content" style="font-family: 'Open Sans', sans-serif;">
                    {{ call.first_name }} {{ call.last_name }}
                </div>

                <div class="flex-1 min-w-0 pr-3">
                    <span class="{% if not call.is_read %}font-semibold{% endif %} text-indigo-700 font-content" style="font-family: 'Open Sans', sans-serif;">{{ call.date|date:"M d" }} at {{ call.time_slot|default:'TBD' }}</span>
                    <span class="text-gray-600 font-content" style="font-family: 'Open Sans', sans-serif;"> â€” {{ call.get_subject_display|default:'Call Request' }}</span>
                </div>

                <div class="w-20 sm:w-24 text-right text-sm text-gray-500 flex-shrink-0 relative">
                    <div class="date-column transition-opacity duration-150">
                        {% if call.is_confirmed %}
                            <span class="text-xs font-semibold text-green-600">Confirmed</span>
                        {% else %}
                            <span class="text-xs font-semibold text-yellow-600">Pending</span>
                        {% endif %}
                    </div>
                    
                    <div class="icon-wrapper absolute top-1/2 right-0 transform -translate-y-1/2 space-x-2 hidden sm:flex opacity-0 transition-opacity duration-150">
                        {% if not call.is_confirmed %}
                        <a href="{% url 'admin_confirm_call' call.id %}" class="text-green-600 hover:text-green-800" title="Confirm">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </a>
                        <a href="{% url 'admin_decline_call' call.id %}" class="text-red-600 hover:text-red-800" title="Decline">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </a>
                        {% endif %}
                        <button class="text-gray-500 hover:text-gray-700 archive-btn" title="Archive" data-call-id="{{ call.id }}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                        </button>
                        <button class="text-gray-500 hover:text-gray-700 delete-btn" title="Delete" data-call-id="{{ call.id }}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
            </article>
            {% empty %}
            <div class="p-4 text-center text-gray-500 font-content" style="font-family: 'Open Sans', sans-serif;">
                No scheduled calls.
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="callModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
        <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto font-content message-modal" style="font-family: 'Montserrat', sans-serif;">
            
            <div class="modal-header bg-[#182942] p-4 rounded-t-3xl border-b-2 border-[#ebd19e] flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <svg class="w-8 h-8 text-[#ebd19e]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                    <h2 id="modalSubject" class="text-lg sm:text-xl font-semibold text-white font-header" style="font-family: 'Hoefler Text', serif;"></h2>
                </div>
                <button id="closeModal" class="text-white hover:text-gray-300" title="Close">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="modal-body p-4 sm:p-6">
                <table class="w-full bg-[#f4f4f4] p-4 rounded-lg border-l-4 border-[#ebd19e]">
                    <tr>
                        <td class="py-2 text-sm text-[#333]"><span class="font-semibold text-[#314769] inline-block w-[100px]">Client:</span> <span id="modalName"></span></td>
                    </tr>
                    <tr>
                        <td class="py-2 text-sm text-[#333]"><span class="font-semibold text-[#314769] inline-block w-[100px]">Email:</span> <span id="modalEmail"></span></td>
                    </tr>
                    <tr>
                        <td class="py-2 text-sm text-[#333]"><span class="font-semibold text-[#314769] inline-block w-[100px]">Phone:</span> <span id="modalPhone"></span></td>
                    </tr>
                    <tr>
                        <td class="py-2 text-sm text-[#333]"><span class="font-semibold text-[#314769] inline-block w-[100px]">Topic:</span> <span id="modalSubjectField"></span></td>
                    </tr>
                    <tr>
                        <td class="py-2 text-sm text-[#333]"><span class="font-semibold text-[#314769] inline-block w-[100px]">Date:</span> <span id="modalDate"></span></td>
                    </tr>
                    <tr>
                        <td class="py-2 text-sm text-[#333]"><span class="font-semibold text-[#314769] inline-block w-[100px]">Time:</span> <span id="modalTime"></span></td>
                    </tr>
                    <tr>
                        <td class="py-2 text-sm text-[#333]"><span class="font-semibold text-[#314769] inline-block w-[100px]">Confirmed:</span> <span id="modalConfirmed"></span></td>
                    </tr>
                </table>
                <div id="modalActions" class="mt-4 flex justify-end space-x-2">
                    </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Custom styles (merged from both templates for consistency) */
:root {
    --brand: #011425;
    --accent: #4f46e5;
    --font-header: 'EB Garamond', serif;
    --font-content: 'Open Sans', sans-serif;
}

.message-row .icon-wrapper {
    opacity: 0;
    transition: opacity 0.15s ease-in-out;
}
.message-row:hover .icon-wrapper {
    opacity: 1;
}
.message-row:hover .date-column {
    opacity: 0;
}
.message-row:hover {
    background-color: #f5f7ff; /* Lighter indigo hover */
}
.message-row {
    font-family: var(--font-content);
}
.font-header {
    font-family: var(--font-header);
}
.font-content {
    font-family: var(--font-content);
}
.rounded-3xl {
    border-radius: 1.25rem;
}
.shadow-2xl {
    box-shadow: 0 25px 50px -12px rgba(2,6,23,0.35);
}
/* Modal Styles for better appearance */
.message-modal {
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    transform: scale(0.95);
    opacity: 0;
}
.message-modal.active {
    transform: scale(1);
    opacity: 1;
}
/* Ensure consistent width to prevent jumping */
.message-row .w-20 {
    min-width: 5rem;
}
.message-row .w-24 {
    min-width: 6rem;
}
@media (min-width: 640px) {
    .message-row .w-20 {
        min-width: 6rem;
    }
    .message-row .w-32 {
        min-width: 8rem;
    }
}
@media (max-width: 640px) {
    .message-row {
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.75rem; /* Increased padding slightly for mobile */
    }
    .message-row > div:nth-child(1) { /* Checkbox/Star */
        order: 1;
        flex-shrink: 0;
    }
    .message-row > div:nth-child(2) { /* Name */
        order: 2;
        flex: 1 1 auto;
        min-width: 0;
    }
    .message-row > div:nth-child(3) { /* Summary */
        order: 3;
        flex: 1 1 100%;
        min-width: 0;
    }
    .message-row > div:nth-child(4) { /* Date/Actions */
        order: 4;
        width: auto;
        min-width: 0;
    }
    .star-icon {
        display: none;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Setup Variables ---
    const selectAll = document.getElementById('selectAll');
    const callRows = document.querySelectorAll('.message-row');
    const modal = document.getElementById('callModal');
    const modalContent = modal.querySelector('.message-modal');
    const closeModalButton = modal.querySelector('#closeModal');

    // Modal Field Elements
    const modalName = document.getElementById('modalName');
    const modalEmail = document.getElementById('modalEmail');
    const modalPhone = document.getElementById('modalPhone');
    const modalSubject = document.getElementById('modalSubject'); // Title in modal header
    const modalSubjectField = document.getElementById('modalSubjectField'); // Field inside modal body table
    const modalDate = document.getElementById('modalDate');
    const modalTime = document.getElementById('modalTime');
    const modalConfirmed = document.getElementById('modalConfirmed');
    const modalActions = document.getElementById('modalActions');
    const subjectFilter = document.getElementById('subjectFilter');
    
    // --- Functions ---
    const hideModal = () => {
        modalContent.classList.remove('active');
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 300); // Match CSS transition duration
    };

    const showModal = (callData) => {
        // Populate modal
        modalName.textContent = `${callData.firstName} ${callData.lastName}`;
        modalEmail.textContent = callData.email;
        modalPhone.textContent = callData.phone;
        modalSubject.textContent = callData.subject;
        modalSubjectField.textContent = callData.subject;
        modalDate.textContent = callData.date;
        modalTime.textContent = callData.time;
        
        // Status with color
        if (callData.confirmed === 'Yes') {
            modalConfirmed.innerHTML = '<span class="text-green-600 font-bold">Confirmed</span>';
        } else {
            modalConfirmed.innerHTML = '<span class="text-yellow-600 font-bold">Pending</span>';
        }

        // Action Buttons
        modalActions.innerHTML = '';
        if (callData.confirmed === 'No') {
            modalActions.innerHTML = `
                <a href="/admin-dashboard/call/confirm/${callData.callId}/" class="px-4 py-2 text-xs bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold shadow-sm">Confirm</a>
                <a href="/admin-dashboard/call/decline/${callData.callId}/" class="px-4 py-2 text-xs bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold shadow-sm">Decline</a>
            `;
        }

        // Show modal with animation classes
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        // Force reflow to ensure transition runs
        void modalContent.offsetWidth;
        modalContent.classList.add('active');
    };

    // --- Event Listeners ---

    // 1. Select All
    selectAll.addEventListener('change', () => {
        document.querySelectorAll('.call-checkbox').forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
    });

    // 2. Row Click Handler (Opens Modal)
    callRows.forEach(row => {
        row.addEventListener('click', (event) => {
            const interactiveElements = event.target.closest('input[type="checkbox"], button, svg, a');
            if (interactiveElements) {
                return; // Prevent modal open if clicking an action
            }

            const callData = row.dataset;
            showModal(callData);

            // Mark as read visually
            row.classList.remove('bg-blue-50');
            row.querySelectorAll('.font-semibold').forEach(el => {
                el.classList.remove('font-semibold');
            });
            
            // NOTE: Replace this mock AJAX with your actual Django mark-read URL
            fetch(`/admin/scheduled-calls/${callData.callId}/mark-read/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            }).catch(err => console.error('Error marking as read:', err));
        });
    });

    // 3. Close Modal handlers
    closeModalButton.addEventListener('click', hideModal);
    modal.addEventListener('click', (event) => {
        if (event.target === modal) {
            hideModal();
        }
    });

    // 4. Subject Filter
    subjectFilter.addEventListener('change', () => {
        const selectedSubject = subjectFilter.value;
        callRows.forEach(row  => {
            const subject = row.dataset.subject; // Get subject from data attribute
            row.style.display = selectedSubject === '' || subject === selectedSubject ? 'flex' : 'none';
        });
    });

    // 5. Star, Archive, Delete handlers (Simplified, assuming standard AJAX actions)
    const handleAction = (event, endpoint, method = 'POST') => {
        event.stopPropagation();
        const callId = event.target.closest('.message-row').getAttribute('data-call-id') || event.target.getAttribute('data-call-id');
        
        if (!callId) {
             console.error('Call ID not found for action.');
             return;
        }

        const fetchOptions = {
            method: method,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        };

        fetch(endpoint.replace('{id}', callId), fetchOptions)
            .then(response => {
                if (response.ok) {
                    if (endpoint.includes('delete') || endpoint.includes('archive')) {
                        event.target.closest('.message-row').remove();
                    } else if (endpoint.includes('toggle-star')) {
                        const star = event.target.closest('svg');
                        const isStarred = star.getAttribute('fill') === 'currentColor';
                        star.setAttribute('fill', isStarred ? 'none' : 'currentColor');
                        star.classList.toggle('text-yellow-500', !isStarred);
                        star.classList.toggle('text-gray-400', isStarred);
                    }
                }
            })
            .catch(err => console.error(`Error performing action for ${endpoint}:`, err));
    };

    document.querySelectorAll('.star-icon').forEach(star => star.addEventListener('click', (e) => handleAction(e, `/admin/scheduled-calls/{id}/toggle-star/`)));
    document.querySelectorAll('.archive-btn').forEach(btn => btn.addEventListener('click', (e) => handleAction(e, `/admin/scheduled-calls/{id}/archive/`)));
    document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => handleAction(e, `/admin/scheduled-calls/{id}/delete/`)));
});
</script>
{% endblock %}